---
layout: default
title: Example 4 - Robust Dictionary Client Module
---
  <head>
    <title>C++ Micro Services: Example 4 - Robust Dictionary Client Module</title>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="doxygen_extra.css" rel="stylesheet" type="text/css"/>
  </head>
  <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="MicroServices_Tutorials.html">Tutorial</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Example 4 - Robust Dictionary Client <a class="el" href="classModule.html" title="Represents a CppMicroServices module. ">Module</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In <a class="el" href="MicroServices_Example3.html">Example 3</a>, we create a simple client module for our dictionary service. The problem with that client was that it did not monitor the dynamic availability of the dictionary service, thus an error would occur if the dictionary service disappeared while the client was using it. In this example we create a client for the dictionary service that monitors the dynamic availability of the dictionary service. The result is a more robust client.</p>
<p>The functionality of the new dictionary client is essentially the same as the old client, it reads words from standard input and checks for their existence in the dictionary service. Our module uses its module context to register itself as a service event listener; monitoring service events allows the module to monitor the dynamic availability of the dictionary service. Our client uses the first dictionary service it finds. The source code for our module is as follows in a file called <code>Activator.cpp</code>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;IDictionaryService.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;usModuleActivator.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;usModuleContext.h&gt;</span></div>
<div class="line"></div>
<div class="line">US_USE_NAMESPACE</div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * This class implements a module activator that uses a dictionary service to check for</span></div>
<div class="line"><span class="comment"> * the proper spelling of a word by checking for its existence in the</span></div>
<div class="line"><span class="comment"> * dictionary. This module is more complex than the module in Example 3 because</span></div>
<div class="line"><span class="comment"> * it monitors the dynamic availability of the dictionary services. In other</span></div>
<div class="line"><span class="comment"> * words, if the service it is using departs, then it stops using it gracefully,</span></div>
<div class="line"><span class="comment"> * or if it needs a service and one arrives, then it starts using it</span></div>
<div class="line"><span class="comment"> * automatically. As before, the module uses the first service that it finds and</span></div>
<div class="line"><span class="comment"> * uses the calling thread of the Load() method to read words from standard</span></div>
<div class="line"><span class="comment"> * input. You can stop checking words by entering an empty line, but to start</span></div>
<div class="line"><span class="comment"> * checking words again you must unload and then load the module again.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">class </span>US_ABI_LOCAL Activator : <span class="keyword">public</span> <a class="code" href="structModuleActivator.html">ModuleActivator</a></div>
<div class="line">{</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"></div>
<div class="line">  Activator()</div>
<div class="line">   : m_context(NULL)</div>
<div class="line">   , m_dictionary(NULL)</div>
<div class="line">  {}</div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  /**</span></div>
<div class="line"><span class="comment">   * Implements ModuleActivator::Load(). Adds itself as a listener for service</span></div>
<div class="line"><span class="comment">   * events, then queries for available dictionary services. If any</span></div>
<div class="line"><span class="comment">   * dictionaries are found it gets a reference to the first one available and</span></div>
<div class="line"><span class="comment">   * then starts its &quot;word checking loop&quot;. If no dictionaries are found, then</span></div>
<div class="line"><span class="comment">   * it just goes directly into its &quot;word checking loop&quot;, but it will not be</span></div>
<div class="line"><span class="comment">   * able to check any words until a dictionary service arrives; any arriving</span></div>
<div class="line"><span class="comment">   * dictionary service will be automatically used by the client if a</span></div>
<div class="line"><span class="comment">   * dictionary is not already in use. Once it has dictionary, it reads words</span></div>
<div class="line"><span class="comment">   * from standard input and checks for their existence in the dictionary that</span></div>
<div class="line"><span class="comment">   * it is using.</span></div>
<div class="line"><span class="comment">   *</span></div>
<div class="line"><span class="comment">   * \note It is very bad practice to use the calling thread to perform a</span></div>
<div class="line"><span class="comment">   *       lengthy process like this; this is only done for the purpose of</span></div>
<div class="line"><span class="comment">   *       the tutorial.</span></div>
<div class="line"><span class="comment">   *</span></div>
<div class="line"><span class="comment">   * @param context the module context for this module.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="structModuleActivator.html#a1db3f85c15a814a5918eb22725229967">Load</a>(<a class="code" href="classModuleContext.html">ModuleContext</a> *context)</div>
<div class="line">  {</div>
<div class="line">    m_context = context;</div>
<div class="line"></div>
<div class="line">    {</div>
<div class="line">      <span class="comment">// Use your favorite thread library to synchronize member</span></div>
<div class="line">      <span class="comment">// variable access within this scope while registering</span></div>
<div class="line">      <span class="comment">// the service listener and performing our initial</span></div>
<div class="line">      <span class="comment">// dictionary service lookup since we</span></div>
<div class="line">      <span class="comment">// don&#39;t want to receive service events when looking up the</span></div>
<div class="line">      <span class="comment">// dictionary service, if one exists.</span></div>
<div class="line">      <span class="comment">// MutexLocker lock(&amp;m_mutex);</span></div>
<div class="line"></div>
<div class="line">      <span class="comment">// Listen for events pertaining to dictionary services.</span></div>
<div class="line">      m_context-&gt;<a class="code" href="classModuleContext.html#a649b0101ead2e7beef159191484b7913">AddServiceListener</a>(<span class="keyword">this</span>, &amp;Activator::ServiceChanged,</div>
<div class="line">                                    std::string(<span class="stringliteral">&quot;(&amp;(&quot;</span>) + <a class="code" href="namespaceServiceConstants.html#a0e099b4cc3cf6e80301486024950b262">ServiceConstants::OBJECTCLASS</a>() + <span class="stringliteral">&quot;=&quot;</span> +</div>
<div class="line">                                    us_service_interface_iid&lt;IDictionaryService&gt;() + <span class="stringliteral">&quot;)&quot;</span> + <span class="stringliteral">&quot;(Language=*))&quot;</span>);</div>
<div class="line"></div>
<div class="line">      <span class="comment">// Query for any service references matching any language.</span></div>
<div class="line">      std::vector&lt;ServiceReference&lt;IDictionaryService&gt; &gt; refs =</div>
<div class="line">          context-&gt;<a class="code" href="classModuleContext.html#a8b1be96ec5dcf6452d5e3f236c9fd20a">GetServiceReferences</a>&lt;IDictionaryService&gt;(<span class="stringliteral">&quot;(Language=*)&quot;</span>);</div>
<div class="line"></div>
<div class="line">      <span class="comment">// If we found any dictionary services, then just get</span></div>
<div class="line">      <span class="comment">// a reference to the first one so we can use it.</span></div>
<div class="line">      <span class="keywordflow">if</span> (!refs.empty())</div>
<div class="line">      {</div>
<div class="line">        m_ref = refs.front();</div>
<div class="line">        m_dictionary = m_context-&gt;GetService(m_ref);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Enter a blank line to exit.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Loop endlessly until the user enters a blank line</span></div>
<div class="line">    <span class="keywordflow">while</span> (std::cin)</div>
<div class="line">    {</div>
<div class="line">      <span class="comment">// Ask the user to enter a word.</span></div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;Enter word: &quot;</span>;</div>
<div class="line"></div>
<div class="line">      std::string word;</div>
<div class="line">      std::getline(std::cin, word);</div>
<div class="line"></div>
<div class="line">      <span class="comment">// If the user entered a blank line, then</span></div>
<div class="line">      <span class="comment">// exit the loop.</span></div>
<div class="line">      <span class="keywordflow">if</span> (word.empty())</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">      <span class="comment">// If there is no dictionary, then say so.</span></div>
<div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_dictionary == NULL)</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;No dictionary available.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">      <span class="comment">// Otherwise print whether the word is correct or not.</span></div>
<div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_dictionary-&gt;CheckWord( word ))</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Correct.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Incorrect.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  /**</span></div>
<div class="line"><span class="comment">   * Implements ModuleActivator::Unload(). Does nothing since</span></div>
<div class="line"><span class="comment">   * the C++ Micro Services library will automatically unget any used services.</span></div>
<div class="line"><span class="comment">   * @param context the context for the module.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="structModuleActivator.html#a410a3f54b7cad990e8d670450677218c">Unload</a>(<a class="code" href="classModuleContext.html">ModuleContext</a>* <span class="comment">/*context*/</span>)</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// NOTE: The service is automatically released.</span></div>
<div class="line">  }</div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  /**</span></div>
<div class="line"><span class="comment">   * Implements ServiceListener.serviceChanged(). Checks to see if the service</span></div>
<div class="line"><span class="comment">   * we are using is leaving or tries to get a service if we need one.</span></div>
<div class="line"><span class="comment">   *</span></div>
<div class="line"><span class="comment">   * @param event the fired service event.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <span class="keywordtype">void</span> ServiceChanged(<span class="keyword">const</span> <a class="code" href="classServiceEvent.html">ServiceEvent</a> event)</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// Use your favorite thread library to synchronize this</span></div>
<div class="line">    <span class="comment">// method with the Load() method.</span></div>
<div class="line">    <span class="comment">// MutexLocker lock(&amp;m_mutex);</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// If a dictionary service was registered, see if we</span></div>
<div class="line">    <span class="comment">// need one. If so, get a reference to it.</span></div>
<div class="line">    <span class="keywordflow">if</span> (event.<a class="code" href="classServiceEvent.html#a5aa8635186e778407c75dbbd3b0a5fc8">GetType</a>() == <a class="code" href="classServiceEvent.html#ae7426fe742bd938523b64d43c232a49fa658bb6e21586fc2d75ca841244199cd2">ServiceEvent::REGISTERED</a>)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (!m_ref)</div>
<div class="line">      {</div>
<div class="line">        <span class="comment">// Get a reference to the service object.</span></div>
<div class="line">        m_ref = <span class="keyword">event</span>.GetServiceReference();</div>
<div class="line">        m_dictionary = m_context-&gt;GetService(m_ref);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// If a dictionary service was unregistered, see if it</span></div>
<div class="line">    <span class="comment">// was the one we were using. If so, unget the service</span></div>
<div class="line">    <span class="comment">// and try to query to get another one.</span></div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event.<a class="code" href="classServiceEvent.html#a5aa8635186e778407c75dbbd3b0a5fc8">GetType</a>() == <a class="code" href="classServiceEvent.html#ae7426fe742bd938523b64d43c232a49fa2727d97ff0e689285e6364afe42ecf81">ServiceEvent::UNREGISTERING</a>)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (event.<a class="code" href="classServiceEvent.html#af5eebd40c7f4d97c805ca46c2ed7ef64">GetServiceReference</a>() == m_ref)</div>
<div class="line">      {</div>
<div class="line">        <span class="comment">// Unget service object and null references.</span></div>
<div class="line">        m_context-&gt;UngetService(m_ref);</div>
<div class="line">        m_ref = 0;</div>
<div class="line">        m_dictionary = NULL;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Query to see if we can get another service.</span></div>
<div class="line">        std::vector&lt;ServiceReference&lt;IDictionaryService&gt; &gt; refs;</div>
<div class="line">        <span class="keywordflow">try</span></div>
<div class="line">        {</div>
<div class="line">          refs = m_context-&gt;GetServiceReferences&lt;IDictionaryService&gt;(<span class="stringliteral">&quot;(Language=*)&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::invalid_argument&amp; e)</div>
<div class="line">        {</div>
<div class="line">          std::cout &lt;&lt; e.what() &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!refs.empty())</div>
<div class="line">        {</div>
<div class="line">          <span class="comment">// Get a reference to the first service object.</span></div>
<div class="line">          m_ref = refs.front();</div>
<div class="line">          m_dictionary = m_context-&gt;GetService(m_ref);</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Module context</span></div>
<div class="line">  <a class="code" href="classModuleContext.html">ModuleContext</a>* m_context;</div>
<div class="line"></div>
<div class="line">  <span class="comment">// The service reference being used</span></div>
<div class="line">  <a class="code" href="classServiceReference.html">ServiceReference&lt;IDictionaryService&gt;</a> m_ref;</div>
<div class="line"></div>
<div class="line">  <span class="comment">// The service object being used</span></div>
<div class="line">  IDictionaryService* m_dictionary;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__MicroServices.html#gac441a2e64f59a76a5f7e42de67e87cba">US_EXPORT_MODULE_ACTIVATOR</a>(dictionaryclient2, Activator)</div>
</div><!-- fragment --><p> The client listens for service events indicating the arrival or departure of dictionary services. If a new dictionary service arrives, the module will start using that service if and only if it currently does not have a dictionary service. If an existing dictionary service disappears, the module will check to see if the disappearing service is the one it is using; if it is it stops using it and tries to query for another dictionary service, otherwise it ignores the event.</p>
<p>As in Example 3, we must link our module to the <code>dictionaryservice</code> module:</p>
<div class="fragment"><div class="line">set(_srcs Activator.cpp)</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__MicroServicesCMake.html#ga9b72f7ba11ea53a3039893522d318168">usFunctionGenerateModuleInit</a>(_srcs</div>
<div class="line">                             NAME &quot;Dictionary Client 2&quot;</div>
<div class="line">                             LIBRARY_NAME &quot;dictionaryclient2&quot;)</div>
<div class="line"></div>
<div class="line">set(dictionaryclient2_DEPENDS dictionaryservice)</div>
<div class="line">CreateExample(dictionaryclient2 ${_srcs})</div>
</div><!-- fragment --><p>After running the <code>CppMicroServicesExampleDriver</code> executable, and loading the event listener module, we can use the <code>l dictionaryclient2</code> command to load our robust dictionary client module:</p>
<pre class="fragment">CppMicroServices-debug&gt; bin/CppMicroServicesExampleDriver
&gt; l eventlistener
Starting to listen for service events.
&gt; l dictionaryclient2
Ex1: Service of type IDictionaryService/1.0 registered.
Enter a blank line to exit.
Enter word:
</pre><p>The above command loads the module and its dependencies (the <code>dictionaryservice</code> module) in a single step. When we load the module, it will use the main thread to prompt us for words. Enter one word at a time to check the words and enter a blank line to stop checking words. To reload the module, we must use the <code>s</code> command to get the module identifier number for the module and first use the <code>u &lt;id&gt;</code> command to unload the module, then the <code>l &lt;id&gt;</code> command to re-load it. To test the dictionary service, enter any of the words in the dictionary (e.g., "welcome", "to", "the", "micro", "services", "tutorial") or any word not in the dictionary.</p>
<p>Since this client monitors the dynamic availability of the dictionary service, it is robust in the face of sudden departures of the the dictionary service. Further, when a dictionary service arrives, it automatically gets the service if it needs it and continues to function. These capabilities are a little difficult to demonstrate since we are using a simple single-threaded approach, but in a multi-threaded or GUI-oriented application this robustness is very useful.</p>
<p>Next: <a class="el" href="MicroServices_Example5.html">Example 5 - Service Tracker Dictionary Client Module</a></p>
<p>Previous: <a class="el" href="MicroServices_Example3.html">Example 3 - Dictionary Client Module</a> </p>
</div></div><!-- contents -->

  <hr class="footer"/>
  <address class="footer"><small>Generated on Mon Dec 23 2013 for C++ Micro Services 2.0.0 by <a href="http://www.doxygen.org/index.html">Doxygen</a> 1.8.5
</small></address>
